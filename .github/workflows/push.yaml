name: build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at midnight

permissions:
  packages: write
  contents: write

jobs:
  find-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v5

      - name: Find Dockerfiles and generate matrix
        id: set-matrix
        run: |
          dockerfiles=$(find . -name "Dockerfile" -type f | grep -v node_modules | sed 's|^\./||')
          matrix_json="["
          first=true
          for dockerfile in $dockerfiles; do
            dir=$(dirname "$dockerfile")
            # Convert directory path to image name (replace / with -)
            image_name=$(echo "$dir" | tr '/' '-')
            if [ "$first" = true ]; then
              first=false
            else
              matrix_json+=","
            fi
            matrix_json+="{\"dockerfile\":\"$dockerfile\",\"context\":\"$dir\",\"image\":\"$image_name\"}"
          done
          matrix_json+="]"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles matrix: $matrix_json"

  build:
    needs: find-dockerfiles
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
        dockerfile: ${{ fromJson(needs.find-dockerfiles.outputs.matrix) }}
    timeout-minutes: 30
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - name: Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set platform
        id: platform
        run: |
          if [[ "${{ matrix.os }}" == *"-arm"* ]]; then
            echo "platform=linux/arm64" >> $GITHUB_OUTPUT
            echo "platform_tag=linux-arm64" >> $GITHUB_OUTPUT
          else
            echo "platform=linux/amd64" >> $GITHUB_OUTPUT
            echo "platform_tag=linux-amd64" >> $GITHUB_OUTPUT
          fi

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.dockerfile.context }}
          file: ${{ matrix.dockerfile.dockerfile }}
          push: true
          platforms: ${{ steps.platform.outputs.platform }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.dockerfile.image }}:${{ github.ref_name }}-${{ steps.platform.outputs.platform_tag }}
          cache-from: type=gha,scope=${{ matrix.dockerfile.image }}-${{ steps.platform.outputs.platform_tag }}
          cache-to: type=gha,mode=max,scope=${{ matrix.dockerfile.image }}-${{ steps.platform.outputs.platform_tag }}
  
  create-manifest:
    needs: [find-dockerfiles, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile: ${{ fromJson(needs.find-dockerfiles.outputs.matrix) }}
    steps:
      - name: Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          docker buildx imagetools create -t ghcr.io/${{ github.repository_owner }}/${{ matrix.dockerfile.image }}:${{ github.ref_name }} \
            -t ghcr.io/${{ github.repository_owner }}/${{ matrix.dockerfile.image }}:latest \
            ghcr.io/${{ github.repository_owner }}/${{ matrix.dockerfile.image }}:${{ github.ref_name }}-linux-amd64 \
            ghcr.io/${{ github.repository_owner }}/${{ matrix.dockerfile.image }}:${{ github.ref_name }}-linux-arm64
